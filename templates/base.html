<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>واصل - Wasel | نظام الاتصال الآلي</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="loader-overlay" id="loader">
        <div class="spinner"></div>
        <p class="mt-3 fw-bold">جاري المعالجة...</p>
    </div>
    <div class="wrapper">
        <!-- القائمة الجانبية -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Wasel Logo" class="img-fluid mb-2" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <h3 style="display:none;"><i class="fas fa-headset me-2"></i> واصل - Wasel</h3>
            </div>

            <ul class="list-unstyled components">
                <li class="{{ 'active' if request.endpoint == 'index' else '' }}">
                    <a href="{{ url_for('index') }}">
                        <i class="fas fa-home"></i> لوحة التحكم
                    </a>
                </li>
                
                {% if current_user.can('campaigns', 'view') %}
                <li class="{{ 'active' if 'campaign' in request.endpoint else '' }}">
                    <a href="{{ url_for('campaigns') }}">
                        <i class="fas fa-bullhorn"></i> إدارة الحملات
                    </a>
                </li>
                {% endif %}
                
                {% if current_user.can('test_call', 'view') %}
                <li class="{{ 'active' if request.endpoint == 'test_call_501' else '' }}">
                    <a href="{{ url_for('test_call_501') }}">
                        <i class="fas fa-vial"></i> اتصال تجريبي
                    </a>
                </li>
                {% endif %}
                
                {% if current_user.can('monitor', 'view') %}
                <li>
                    <a href="#monitorSubmenu" data-bs-toggle="collapse" aria-expanded="false" class="dropdown-toggle">
                        <i class="fas fa-desktop"></i> أدوات المراقبة
                    </a>
                    <ul class="collapse list-unstyled {{ 'show' if request.endpoint in ['monitor', 'command_screen', 'view_logs'] else '' }}" id="monitorSubmenu">
                        <li class="{{ 'active' if request.endpoint == 'monitor' else '' }}">
                            <a href="{{ url_for('monitor') }}">المراقبة الحية</a>
                        </li>
                        {% if current_user.can('command_screen', 'view') %}
                        <li class="{{ 'active' if request.endpoint == 'command_screen' else '' }}">
                            <a href="{{ url_for('command_screen') }}">شاشة الأوامر</a>
                        </li>
                        {% endif %}
                        <li class="{{ 'active' if request.endpoint == 'view_logs' else '' }}">
                            <a href="{{ url_for('view_logs') }}">سجلات النظام</a>
                        </li>
                    </ul>
                </li>
                {% endif %}

                {% if current_user.can('contacts', 'view') %}
                <li class="{{ 'active' if request.endpoint == 'contacts_page' else '' }}">
                    <a href="{{ url_for('contacts_page') }}">
                        <i class="fas fa-address-book"></i> إدارة جهات الاتصال
                    </a>
                </li>
                {% endif %}

                {% if current_user.can('reports', 'view') %}
                <li class="{{ 'active' if request.endpoint == 'reports' else '' }}">
                    <a href="{{ url_for('reports') }}">
                        <i class="fas fa-chart-line"></i> التقارير
                    </a>
                </li>
                {% endif %}

                {% if current_user.can('settings', 'view') or current_user.can('settings', 'edit') %}
                <li>
                    <a href="#systemSettingsSubmenu" data-bs-toggle="collapse" aria-expanded="false" class="dropdown-toggle">
                        <i class="fas fa-cogs"></i> إعدادات النظام
                    </a>
                    <ul class="collapse list-unstyled {{ 'show' if request.endpoint in ['settings', 'telegram_settings', 'database_page', 'blacklist', 'packages_page'] else '' }}" id="systemSettingsSubmenu">
                        <li class="{{ 'active' if request.endpoint == 'settings' else '' }}">
                            <a href="{{ url_for('settings') }}">إعدادات النظام</a>
                        </li>
                        <li class="{{ 'active' if request.endpoint == 'telegram_settings' else '' }}">
                            <a href="{{ url_for('telegram_settings') }}">إعدادات البوت والتنبيهات</a>
                        </li>
                        {% if current_user.can('database', 'view') %}
                        <li class="{{ 'active' if request.endpoint == 'database_page' else '' }}">
                            <a href="{{ url_for('database_page') }}">إدارة قاعدة البيانات</a>
                        </li>
                        {% endif %}
                        <li class="{{ 'active' if request.endpoint == 'blacklist' else '' }}">
                            <a href="{{ url_for('blacklist') }}">القائمة السوداء</a>
                        </li>
                         {% if current_user.can('packages', 'view') %}
                        <li class="{{ 'active' if request.endpoint == 'packages_page' else '' }}">
                            <a href="{{ url_for('packages_page') }}">الباقات والعروض</a>
                        </li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                {% if current_user.can('users', 'view') or current_user.can('roles', 'view') %}
                <li>
                    <a href="#userManagementSubmenu" data-bs-toggle="collapse" aria-expanded="false" class="dropdown-toggle">
                        <i class="fas fa-users-cog"></i> إدارة المستخدمين
                    </a>
                    <ul class="collapse list-unstyled {{ 'show' if request.endpoint in ['users', 'roles'] else '' }}" id="userManagementSubmenu">
                        {% if current_user.can('users', 'view') %}
                        <li class="{{ 'active' if request.endpoint == 'users' else '' }}">
                            <a href="{{ url_for('users') }}">المستخدمين</a>
                        </li>
                        {% endif %}
                        {% if current_user.can('roles', 'view') %}
                        <li class="{{ 'active' if request.endpoint == 'roles' else '' }}">
                            <a href="{{ url_for('roles') }}">الأدوار والصلاحيات</a>
                        </li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}
            </ul>

            <div class="text-center mt-5 text-muted small px-3">
                <p>نسخة 1.4<br>تطوير واصل - Wasel</p>
            </div>
        </nav>
        
        <!-- المحتوى الرئيسي -->
        <div class="content">
            <!-- رأس الصفحة -->
            <header class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom bg-white p-3 rounded shadow-sm">
                <div class="d-flex align-items-center">
                    <button type="button" id="sidebarCollapse" class="btn btn-light rounded-circle me-3 d-md-none shadow-sm">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h2 class="h4 text-primary m-0">
                        {% block header_title %}نظرة عامة{% endblock %}
                    </h2>
                </div>
                <div class="d-flex align-items-center">
                    <button class="btn btn-light rounded-circle me-2 shadow-sm" id="darkModeToggle" title="الوضع الليلي">
                        <i class="fas fa-moon"></i>
                    </button>
                    <span class="text-muted small me-2 ms-2 d-none d-md-inline">{{ now_date }}</span>
                    <div class="dropdown">
                        <button class="btn btn-light rounded-pill shadow-sm dropdown-toggle px-3" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user me-1"></i>
                            {% if current_user.is_authenticated %}
                                {{ current_user.username }}
                            {% else %}
                                زائر
                            {% endif %}
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            {% if current_user.is_authenticated %}
                                <li><a class="dropdown-item" href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt me-2 text-danger"></i> تسجيل خروج</a></li>
                            {% else %}
                                <li><a class="dropdown-item" href="{{ url_for('login') }}"><i class="fas fa-sign-in-alt me-2"></i> تسجيل دخول</a></li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </header>

            <!-- رسائل التنبيه (Toasts) -->
            <div class="toast-container position-fixed top-0 start-0 p-3" style="z-index: 1050;">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="toast align-items-center text-white bg-{{ 'danger' if category == 'error' else category }} border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
                                <div class="d-flex">
                                    <div class="toast-body">
                                        <i class="fas fa-{{ 'check-circle' if category == 'success' else 'exclamation-circle' }} me-2"></i>
                                        {{ message }}
                                    </div>
                                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
            </div>

            <div class="fade-in">
                {% block content %}{% endblock %}
            </div>

            <footer class="mt-5 text-center text-muted small">
                <hr>
                <p class="mb-1">&copy; 2025 واصل - Wasel | الإصدار 1.3</p>
                <p class="mb-0">
                    <i class="fab fa-whatsapp text-success me-1"></i> 01016966066 | 
                    <a href="https://www.facebook.com/profile.php?id=61575252946157" target="_blank" class="text-decoration-none text-muted">
                        <i class="fab fa-facebook text-primary me-1"></i> Facebook
                    </a>
                </p>
            </footer>
        </div>
    </div>

    <!-- مكان للمودالز (Modals) لتجنب مشاكل z-index -->
    {% block modals %}{% endblock %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Sidebar Toggle
        const sidebarCollapse = document.getElementById('sidebarCollapse');
        if(sidebarCollapse){
            sidebarCollapse.addEventListener('click', function() {
                document.querySelector('.sidebar').classList.toggle('active');
                document.querySelector('.content').classList.toggle('active');
            });
        }

        // Dark Mode
        const darkModeToggle = document.getElementById('darkModeToggle');
        const body = document.body;
        
        if (localStorage.getItem('darkMode') === 'enabled') {
            body.classList.add('dark-mode');
            if(darkModeToggle) darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        }

        if(darkModeToggle){
            darkModeToggle.addEventListener('click', () => {
                body.classList.toggle('dark-mode');
                if (body.classList.contains('dark-mode')) {
                    localStorage.setItem('darkMode', 'enabled');
                    darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                } else {
                    localStorage.setItem('darkMode', 'disabled');
                    darkModeToggle.innerHTML = '<i class="fas fa-moon"></i>';
                }
            });
        }

        // Initialize Toasts
        var toastElList = [].slice.call(document.querySelectorAll('.toast'))
        var toastList = toastElList.map(function (toastEl) {
            return new bootstrap.Toast(toastEl, { delay: 5000 });
        });
        toastList.forEach(toast => toast.show());

        // Loader
        document.addEventListener('submit', function(e) {
            const loader = document.getElementById('loader');
            if(loader) loader.style.display = 'flex';
        });
    </script>
</body>
</html>
