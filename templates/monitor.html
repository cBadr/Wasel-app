{% extends "base.html" %}

{% block header_title %}المراقبة الحية{% endblock %}

{% block content %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="row">
    <!-- Main Stats Column -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div><i class="fas fa-chart-line me-2"></i> لوحة التحكم المباشرة</div>
                <span class="badge bg-secondary rounded-pill" id="last-update">جاري الاتصال...</span>
            </div>
            <div class="card-body">
                <!-- Campaign Status & Controls -->
                <div class="d-flex justify-content-between align-items-center mb-4 p-3 bg-light rounded border">
                    <div>
                        <h5 class="mb-1" id="active-campaign-name">جاري التحميل...</h5>
                        <span class="badge bg-secondary" id="campaign-status-badge">غير معروف</span>
                    </div>
                    <div id="campaign-controls" style="display: none;">
                        <button id="btn-pause" class="btn btn-warning rounded-pill me-2" onclick="toggleCampaign('pause')">
                            <i class="fas fa-pause me-1"></i> إيقاف مؤقت
                        </button>
                        <button id="btn-resume" class="btn btn-success rounded-pill me-2" onclick="toggleCampaign('resume')">
                            <i class="fas fa-play me-1"></i> تشغيل
                        </button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="row text-center mb-4">
                    <div class="col-md-3">
                        <div class="card border-primary mb-3">
                            <div class="card-body">
                                <h6 class="card-title text-muted">الإجمالي</h6>
                                <h3 class="card-text text-primary fw-bold" id="total-count">-</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-warning mb-3">
                            <div class="card-body">
                                <h6 class="card-title text-muted">قيد الانتظار</h6>
                                <h3 class="card-text text-warning fw-bold" id="pending-count">-</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-info mb-3">
                            <div class="card-body">
                                <h6 class="card-title text-muted">تم الاتصال</h6>
                                <h3 class="card-text text-info fw-bold" id="dialed-count">-</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-success mb-3">
                            <div class="card-body">
                                <h6 class="card-title text-muted">تم الرد</h6>
                                <h3 class="card-text text-success fw-bold" id="answered-count">-</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Progress & Chart Row -->
                <div class="row">
                    <div class="col-md-8">
                        <h6 class="text-muted mb-2">نسبة التقدم</h6>
                        <div class="progress mb-4" style="height: 30px; font-size: 1.1em;">
                            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" style="width: 0%">0%</div>
                        </div>
                        
                        <!-- Active Calls Table -->
                        <div class="card">
                            <div class="card-header bg-white">
                                <i class="fas fa-phone-volume me-2 text-danger animate__animated animate__pulse animate__infinite"></i> المكالمات الجارية الآن
                            </div>
                            <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                                <table class="table table-sm table-hover mb-0">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>الرقم</th>
                                            <th>القناة/الدونجل</th>
                                            <th>وقت البدء</th>
                                            <th>الحالة</th>
                                        </tr>
                                    </thead>
                                    <tbody id="active-calls-body">
                                        <tr id="no-active-calls"><td colspan="4" class="text-center text-muted">لا توجد مكالمات جارية حالياً</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <canvas id="statsChart" width="200" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Side Panel (Logs & Trunks) -->
    <div class="col-md-4">
        <!-- Activity Log -->
        <div class="card mb-4">
            <div class="card-header">
                <div><i class="fas fa-history me-2"></i> سجل النشاطات</div>
            </div>
            <div class="card-body p-0">
                <ul class="list-group list-group-flush" id="activity-log" style="max-height: 300px; overflow-y: auto;">
                    <!-- Logs go here -->
                </ul>
            </div>
        </div>

        {% if current_user.can('monitor_queues', 'view') %}
        <div class="card mb-4">
            <div class="card-header">
                <div><i class="fas fa-users-cog me-2"></i> حالة الطوابير</div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>الطابور</th>
                                <th>المتصلين</th>
                                <th>الانتظار</th>
                            </tr>
                        </thead>
                        <tbody id="queue-list">
                            <tr><td colspan="3" class="text-center text-muted">جاري التحميل...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<div class="row">
    <!-- Extra components like Trunks/Dongles can go here if needed, keeping layout clean -->
    {% if current_user.can('monitor_dongles', 'view') %}
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header" data-bs-toggle="collapse" data-bs-target="#dongleCollapse" style="cursor: pointer;">
                <div><i class="fas fa-server me-2"></i> حالة الدونجلات (Dongles) <small class="text-muted ms-2">(اضغط للعرض/الإخفاء)</small></div>
            </div>
            <div id="dongleCollapse" class="collapse">
                <div class="card-body">
                    <div id="dongle-list" class="d-flex flex-wrap gap-2">
                        <div class="text-center text-muted py-3 w-100">جاري انتظار تحديث الحالة...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
<script>
    const socket = io();
    let statsChart = null;
    let activeCalls = {}; // Map to store active calls: { dongle: { phone, startTime } }

    // Initialize Chart
    function initChart() {
        const ctx = document.getElementById('statsChart').getContext('2d');
        statsChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['تم الرد', 'فشل/لم يتم الرد', 'قيد الانتظار'],
                datasets: [{
                    data: [0, 0, 0],
                    backgroundColor: ['#198754', '#dc3545', '#ffc107'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { boxWidth: 12, font: { size: 10 } }
                    }
                }
            }
        });
    }

    // On Load
    document.addEventListener('DOMContentLoaded', () => {
        initChart();
        updateStats(); // Initial fetch
        setInterval(updateStats, 5000); // Poll every 5 seconds for robust sync
    });

    // Socket Events
    socket.on('connect', () => {
        document.getElementById('last-update').innerHTML = '<i class="fas fa-circle text-success me-1"></i> متصل';
        document.getElementById('last-update').className = 'badge bg-success rounded-pill';
    });

    socket.on('disconnect', () => {
        document.getElementById('last-update').innerHTML = '<i class="fas fa-circle text-danger me-1"></i> غير متصل';
        document.getElementById('last-update').className = 'badge bg-danger rounded-pill';
    });

    socket.on('call_started', (data) => {
        addActivityLog(`بدء الاتصال بالرقم ${data.phone} عبر ${data.dongle}`, 'info');
        
        // Add to active calls
        activeCalls[data.dongle] = {
            phone: data.phone,
            startTime: new Date()
        };
        renderActiveCalls();
        updateStats(); 
    });

    socket.on('call_ended', (data) => {
        addActivityLog(`انتهاء مهمة الدونجل ${data.dongle}`, 'secondary');
        
        // Remove from active calls
        if (activeCalls[data.dongle]) {
            delete activeCalls[data.dongle];
            renderActiveCalls();
        }
        updateStats();
    });

    // Dongle Update
    socket.on('dongle_update', (data) => {
        const dongleList = document.getElementById('dongle-list');
        if (!dongleList) return;

        dongleList.innerHTML = '';
        const allDongles = [...data.free, ...data.allocated].sort();
        
        if (allDongles.length === 0) {
            dongleList.innerHTML = '<div class="text-center text-muted py-3 w-100">لا توجد دونجلات متاحة</div>';
            return;
        }

        allDongles.forEach(dongle => {
            const isAllocated = data.allocated.includes(dongle);
            const statusClass = isAllocated ? 'bg-warning text-dark' : 'bg-success text-white';
            const icon = isAllocated ? 'fa-phone' : 'fa-check';
            
            const item = document.createElement('div');
            item.className = `badge ${statusClass} p-2 d-flex align-items-center`;
            item.style.fontSize = '0.9em';
            item.innerHTML = `<i class="fas ${icon} me-2"></i> ${dongle}`;
            
            if (isAllocated) {
                // Spy buttons
                const btnGroup = document.createElement('div');
                btnGroup.className = 'ms-2 btn-group btn-group-sm';
                btnGroup.innerHTML = `
                    <button class="btn btn-light btn-sm py-0 px-1" onclick="spyChannel('Dongle/${dongle}', 'q')" title="تنسط"><i class="fas fa-headphones"></i></button>
                    <button class="btn btn-dark btn-sm py-0 px-1" onclick="spyChannel('Dongle/${dongle}', 'w')" title="همس"><i class="fas fa-user-secret"></i></button>
                `;
                item.appendChild(btnGroup);
            }
            
            dongleList.appendChild(item);
        });
    });

    // Helper Functions
    function renderActiveCalls() {
        const tbody = document.getElementById('active-calls-body');
        tbody.innerHTML = '';
        
        const dongles = Object.keys(activeCalls);
        if (dongles.length === 0) {
            tbody.innerHTML = '<tr id="no-active-calls"><td colspan="4" class="text-center text-muted">لا توجد مكالمات جارية حالياً</td></tr>';
            return;
        }
        
        dongles.forEach(dongle => {
            const call = activeCalls[dongle];
            const duration = Math.floor((new Date() - call.startTime) / 1000);
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${call.phone}</td>
                <td><span class="badge bg-secondary">${dongle}</span></td>
                <td>${call.startTime.toLocaleTimeString()}</td>
                <td><span class="badge bg-danger animate__animated animate__flash animate__infinite slow">Jarry... (${duration}s)</span></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function updateStats() {
        fetch('/api/stats')
            .then(response => response.json())
            .then(data => {
                // Update text stats
                document.getElementById('total-count').innerText = data.total;
                document.getElementById('pending-count').innerText = data.pending;
                document.getElementById('dialed-count').innerText = data.dialed;
                document.getElementById('answered-count').innerText = data.answered;
                
                // Update Campaign Info
                document.getElementById('active-campaign-name').innerText = data.campaign_name;
                const statusBadge = document.getElementById('campaign-status-badge');
                const controls = document.getElementById('campaign-controls');
                const btnPause = document.getElementById('btn-pause');
                const btnResume = document.getElementById('btn-resume');

                if (data.status === 'active') {
                    statusBadge.className = 'badge bg-success';
                    statusBadge.innerText = 'نشطة';
                    controls.style.display = 'block';
                    btnPause.style.display = 'inline-block';
                    btnResume.style.display = 'none';
                } else if (data.status === 'paused') {
                    statusBadge.className = 'badge bg-warning text-dark';
                    statusBadge.innerText = 'متوقفة مؤقتاً';
                    controls.style.display = 'block';
                    btnPause.style.display = 'none';
                    btnResume.style.display = 'inline-block';
                } else {
                    statusBadge.className = 'badge bg-secondary';
                    statusBadge.innerText = 'خاملة';
                    controls.style.display = 'none';
                }

                // Update Progress Bar
                let percentage = 0;
                if (data.total > 0) {
                    // Adjust based on your backend logic. Usually processed = total - pending
                    const done = data.total - data.pending;
                    percentage = Math.round((done / data.total) * 100);
                }
                const progressBar = document.getElementById('progress-bar');
                progressBar.style.width = percentage + '%';
                progressBar.innerText = percentage + '%';

                // Update Chart
                if (statsChart) {
                    statsChart.data.datasets[0].data = [data.answered, data.failed, data.pending];
                    statsChart.update();
                }
            })
            .catch(err => console.error('Error fetching stats:', err));
    }

    function addActivityLog(message, type='info') {
        const log = document.getElementById('activity-log');
        const item = document.createElement('li');
        item.className = `list-group-item list-group-item-${type} small`;
        item.innerHTML = `<span class="fw-bold text-muted">${new Date().toLocaleTimeString()}</span> - ${message}`;
        log.insertBefore(item, log.firstChild);
        if (log.children.length > 20) log.removeChild(log.lastChild);
    }

    function toggleCampaign(action) {
        if (!confirm('هل أنت متأكد؟')) return;
        
        fetch('/api/stats')
            .then(res => res.json())
            .then(data => {
                if (!data.campaign_id) return;
                
                fetch(`/api/campaign/${data.campaign_id}/status`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ status: action === 'resume' ? 'active' : 'paused' })
                })
                .then(res => res.json())
                .then(resData => {
                    if (resData.success) {
                        updateStats();
                    } else {
                        alert('Error: ' + resData.message);
                    }
                });
            });
    }
    
    // Spy Function (Existing)
    function spyChannel(channel, option = 'q') {
        let actionName = option === 'w' ? 'الهمس (Whisper)' : 'التنسط (Listen)';
        if (!confirm(`هل تريد بدء ${actionName} لهذا الخط؟ سيتم الاتصال بتحويلتك.`)) return;
        
        const formData = new FormData();
        formData.append('channel', channel);
        formData.append('option', option);
        
        fetch('/api/monitor_spy', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('جاري الاتصال بتحويلتك...');
            } else {
                alert('فشل: ' + data.message);
            }
        })
        .catch(err => {
            console.error(err);
            alert('حدث خطأ في الاتصال');
        });
    }
</script>
{% endblock %}