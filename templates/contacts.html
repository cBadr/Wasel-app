
{% extends "base.html" %}

{% block header_title %}إدارة جهات الاتصال{% endblock %}

{% block content %}
<div class="card shadow-sm mb-4">
    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
        <h5 class="mb-0 text-primary"><i class="fas fa-address-book me-2"></i> دليل الأرقام</h5>
        <div>
            {% if current_user.can('contacts', 'edit') %}
            <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addContactModal">
                <i class="fas fa-plus me-1"></i> إضافة رقم
            </button>
            <button class="btn btn-danger btn-sm" id="btn-bulk-delete" disabled onclick="bulkDelete()">
                <i class="fas fa-trash me-1"></i> حذف المحدد
            </button>
            {% endif %}
        </div>
    </div>
    <div class="card-body">
        
        <!-- Filter Form -->
        <form action="{{ url_for('contacts_page') }}" method="GET" class="row g-3 mb-4 border-bottom pb-3">
            <div class="col-md-4">
                <label class="form-label small text-muted">بحث بالرقم</label>
                <input type="text" class="form-control" name="search" value="{{ search_query }}" placeholder="أدخل الرقم...">
            </div>
            <div class="col-md-3">
                <label class="form-label small text-muted">تصفية حسب الحملة</label>
                <select class="form-select" name="campaign_id" onchange="this.form.submit()">
                    <option value="">كل الحملات</option>
                    {% for camp in campaigns %}
                    <option value="{{ camp.id }}" {% if selected_campaign_id == camp.id %}selected{% endif %}>{{ camp.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small text-muted">تصفية حسب الحالة</label>
                <select class="form-select" name="status" onchange="this.form.submit()">
                    <option value="">الكل</option>
                    <option value="pending" {% if selected_status == 'pending' %}selected{% endif %}>قيد الانتظار</option>
                    <option value="dialed" {% if selected_status == 'dialed' %}selected{% endif %}>جاري الاتصال</option>
                    <option value="answered" {% if selected_status == 'answered' %}selected{% endif %}>تم الرد</option>
                    <option value="failed" {% if selected_status == 'failed' %}selected{% endif %}>فشل</option>
                    <option value="retry" {% if selected_status == 'retry' %}selected{% endif %}>إعادة محاولة</option>
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100"><i class="fas fa-search me-1"></i> بحث</button>
            </div>
        </form>

        <!-- Contacts Table -->
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th style="width: 40px;"><input type="checkbox" class="form-check-input" id="select-all"></th>
                        <th>الاسم</th>
                        <th>رقم الهاتف</th>
                        <th>الحملة</th>
                        <th>الحالة</th>
                        <th>آخر اتصال</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody>
                    {% for contact in contacts.items %}
                    <tr>
                        <td><input type="checkbox" class="form-check-input contact-check" value="{{ contact.id }}"></td>
                        <td>{{ contact.name or '-' }}</td>
                        <td class="fw-bold">{{ contact.phone_number }}</td>
                        <td>
                            <span class="badge bg-light text-dark border">{{ contact.campaign.name }}</span>
                        </td>
                        <td>
                            {% if contact.status == 'pending' %}
                                <span class="badge bg-secondary">قيد الانتظار</span>
                            {% elif contact.status == 'dialed' %}
                                <span class="badge bg-info text-dark">جاري الاتصال</span>
                            {% elif contact.status in ['ANSWERED', 'answered'] %}
                                <span class="badge bg-success">تم الرد</span>
                            {% elif contact.status in ['BUSY', 'busy'] %}
                                <span class="badge bg-danger">مشغول</span>
                            {% elif contact.status in ['FAILED', 'failed'] %}
                                <span class="badge bg-danger">فشل الإتصال</span>
                            {% elif contact.status in ['CONGESTION', 'congestion'] %}
                                <span class="badge bg-dark">خارج التغطية</span>
                            {% elif contact.status in ['NO ANSWER', 'no answer'] %}
                                <span class="badge bg-warning text-dark">لا يوجد رد</span>
                            {% elif contact.status == 'retry' %}
                                <span class="badge bg-warning text-dark">إعادة محاولة ({{ contact.retries }})</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ contact.status }}</span>
                            {% endif %}
                        </td>
                        <td class="small text-muted">
                            {% if contact.last_dialed %}
                                {{ contact.last_dialed.strftime('%Y-%m-%d %H:%M') }}<br>
                                <span class="text-xs">المدة: {{ contact.duration }}s</span>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if current_user.can('contacts', 'edit') %}
                            <button class="btn btn-sm btn-outline-primary" onclick="editContact({{ contact.id }}, '{{ contact.phone_number }}', '{{ contact.name or '' }}', {{ contact.campaign_id }})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <a href="{{ url_for('delete_contact_route', contact_id=contact.id) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('هل أنت متأكد؟')">
                                <i class="fas fa-trash"></i>
                            </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center py-5 text-muted">
                            <i class="fas fa-inbox fa-3x mb-3 d-block opacity-25"></i>
                            لا توجد جهات اتصال مطابقة للبحث
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if pagination.pages > 1 %}
        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if pagination.has_prev %}
                <li class="page-item"><a class="page-link" href="{{ url_for('contacts_page', page=pagination.prev_num, search=search_query, campaign_id=selected_campaign_id, status=selected_status) }}">السابق</a></li>
                {% endif %}
                
                {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                    {% if page_num %}
                        <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('contacts_page', page=page_num, search=search_query, campaign_id=selected_campaign_id, status=selected_status) }}">{{ page_num }}</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}
                {% endfor %}

                {% if pagination.has_next %}
                <li class="page-item"><a class="page-link" href="{{ url_for('contacts_page', page=pagination.next_num, search=search_query, campaign_id=selected_campaign_id, status=selected_status) }}">التالي</a></li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}

    </div>
</div>

<!-- Add Contact Modal -->
<div class="modal fade" id="addContactModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">إضافة جهات اتصال</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs mb-3" id="addContactTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="single-tab" data-bs-toggle="tab" data-bs-target="#single" type="button" role="tab">رقم فردي</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="bulk-tab" data-bs-toggle="tab" data-bs-target="#bulk" type="button" role="tab">مجموعة أرقام</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="file-tab" data-bs-toggle="tab" data-bs-target="#file" type="button" role="tab">رفع ملف</button>
                    </li>
                </ul>
                
                <div class="tab-content" id="addContactTabContent">
                    <!-- Single Contact -->
                    <div class="tab-pane fade show active" id="single" role="tabpanel">
                        <form action="{{ url_for('add_single_contact') }}" method="POST">
                            <div class="mb-3">
                                <label class="form-label">رقم الهاتف <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="phone_number" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">الاسم</label>
                                <input type="text" class="form-control" name="name">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">تعيين للحملة <span class="text-danger">*</span></label>
                                <select class="form-select" name="campaign_id" required>
                                    {% for camp in campaigns %}
                                    <option value="{{ camp.id }}">{{ camp.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="text-end">
                                <button type="submit" class="btn btn-primary">حفظ</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Bulk Text -->
                    <div class="tab-pane fade" id="bulk" role="tabpanel">
                        <form action="{{ url_for('import_contacts_general') }}" method="POST">
                            <input type="hidden" name="import_type" value="text">
                            <div class="mb-3">
                                <label class="form-label">أرقام الهواتف (كل رقم في سطر) <span class="text-danger">*</span></label>
                                <textarea class="form-control" name="phone_numbers" rows="10" placeholder="05xxxxxxxx&#10;05xxxxxxxx" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">تعيين للحملة <span class="text-danger">*</span></label>
                                <select class="form-select" name="campaign_id" required>
                                    {% for camp in campaigns %}
                                    <option value="{{ camp.id }}">{{ camp.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="text-end">
                                <button type="submit" class="btn btn-primary">إضافة المجموعة</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- File Upload -->
                    <div class="tab-pane fade" id="file" role="tabpanel">
                        <form action="{{ url_for('import_contacts_general') }}" method="POST" enctype="multipart/form-data">
                            <input type="hidden" name="import_type" value="file">
                            <div class="mb-3">
                                <label class="form-label">ملف CSV أو نصي <span class="text-danger">*</span></label>
                                <input type="file" class="form-control" name="file" accept=".csv,.txt" required>
                                <div class="form-text">يجب أن يكون الملف بصيغة CSV أو TXT. التنسيق: الرقم, الاسم (اختياري)</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">تعيين للحملة <span class="text-danger">*</span></label>
                                <select class="form-select" name="campaign_id" required>
                                    {% for camp in campaigns %}
                                    <option value="{{ camp.id }}">{{ camp.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="text-end">
                                <button type="submit" class="btn btn-primary">رفع واستيراد</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Contact Modal -->
<div class="modal fade" id="editContactModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('update_contact') }}" method="POST">
                <input type="hidden" name="contact_id" id="edit_contact_id">
                <div class="modal-header">
                    <h5 class="modal-title">تعديل جهة الاتصال</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">رقم الهاتف <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="phone_number" id="edit_phone_number" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">الاسم</label>
                        <input type="text" class="form-control" name="name" id="edit_name">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">الحملة <span class="text-danger">*</span></label>
                        <select class="form-select" name="campaign_id" id="edit_campaign_id" required>
                            {% for camp in campaigns %}
                            <option value="{{ camp.id }}">{{ camp.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-primary">حفظ التغييرات</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Handle Checkbox Selection
    const selectAll = document.getElementById('select-all');
    const checks = document.querySelectorAll('.contact-check');
    const bulkBtn = document.getElementById('btn-bulk-delete');

    function updateBulkBtn() {
        const checkedCount = document.querySelectorAll('.contact-check:checked').length;
        bulkBtn.disabled = checkedCount === 0;
        bulkBtn.innerHTML = `<i class="fas fa-trash me-1"></i> حذف المحدد (${checkedCount})`;
    }

    if(selectAll) {
        selectAll.addEventListener('change', function() {
            checks.forEach(c => c.checked = this.checked);
            updateBulkBtn();
        });
    }

    checks.forEach(c => {
        c.addEventListener('change', updateBulkBtn);
    });

    function editContact(id, phone, name, campaignId) {
        document.getElementById('edit_contact_id').value = id;
        document.getElementById('edit_phone_number').value = phone;
        document.getElementById('edit_name').value = name;
        document.getElementById('edit_campaign_id').value = campaignId;
        new bootstrap.Modal(document.getElementById('editContactModal')).show();
    }

    function bulkDelete() {
        if(!confirm('هل أنت متأكد من حذف جهات الاتصال المحددة؟')) return;
        
        const selected = Array.from(document.querySelectorAll('.contact-check:checked')).map(c => c.value);
        
        // Create hidden form to submit
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = "{{ url_for('bulk_delete_contacts') }}";
        
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'contact_ids';
        input.value = JSON.stringify(selected);
        form.appendChild(input);
        
        document.body.appendChild(form);
        form.submit();
    }
</script>
{% endblock %}
